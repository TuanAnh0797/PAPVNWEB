CREATE TABLE `dataplan` (
  `Model` varchar(30) DEFAULT NULL,
  `QuantityDay` int DEFAULT NULL,
  `QuantityPerSec` float DEFAULT NULL,
  `Quantity1` int DEFAULT NULL,
  `Quantity2` int DEFAULT NULL,
  `Quantity3` int DEFAULT NULL,
  `TotalTime` double DEFAULT NULL,
  `TimeStart` datetime DEFAULT NULL,
  `TimeEnd` datetime DEFAULT NULL,
  `TimeUpdate` datetime DEFAULT CURRENT_TIMESTAMP,
  `MonitorSpecial` int DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE DEFINER=`TA`@`localhost` PROCEDURE `ClearAllPlan`()
BEGIN
	DELETE FROM `dataplc`.`dataplan` where Date(TimeUpdate) = Date(now());
END
CREATE DEFINER=`TA`@`localhost` PROCEDURE `GetStartTimeAndEndTimePlan`()
BEGIN
select * from dataplan where Model = 'Total';

END
CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadDataForBarChartPlanGas`()
BEGIN
	DECLARE _hournow int;
    Set _hournow = hour(now());
    IF(_hournow > 5) then
SELECT dataplan.Model, COALESCE(c.QuantityActual, 0) AS QuantityActual, dataplan.QuantityDay,dataplan.Quantity1,dataplan.Quantity2,dataplan.Quantity3,dataplan.QuantityPerSec,dataplan.TimeStart,dataplan.TimeEnd,dataplan.TotalTime
FROM dataplan
LEFT JOIN (
    SELECT Model, COUNT(DISTINCT CodeBack) AS QuantityActual
    FROM dataplan
    LEFT JOIN (
        SELECT * FROM gas
        WHERE Judge = 'OK' AND DATE(TimePLC) = CURDATE() AND HOUR(TimePLC) > 5
    ) AS b ON dataplan.Model = b.CodeModel
    WHERE dataplan.Model <> 'ToTal' AND DATE(dataplan.TimeUpdate) = DATE(NOW())
    GROUP BY dataplan.Model
) AS c ON dataplan.Model = c.Model where dataplan.Model <> 'ToTal' AND DATE(dataplan.TimeUpdate) = DATE(NOW());
    else 
    SELECT dataplan.Model, COALESCE(c.QuantityActual, 0) AS QuantityActual, dataplan.QuantityDay,dataplan.Quantity1,dataplan.Quantity2,dataplan.Quantity3,dataplan.QuantityPerSec,dataplan.TimeStart,dataplan.TimeEnd,dataplan.TotalTime
FROM dataplan
LEFT JOIN (
    SELECT Model, COUNT(DISTINCT CodeBack) AS QuantityActual
    FROM dataplan
    LEFT JOIN (
        SELECT * FROM gas
        WHERE Judge = 'OK' AND ((Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5))
    ) AS b ON dataplan.Model = b.CodeModel
    WHERE dataplan.Model <> 'ToTal' AND Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    GROUP BY dataplan.Model
) AS c ON dataplan.Model = c.Model where dataplan.Model <> 'ToTal' AND Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY);
   
	END IF;
END
CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadDataForBarChartPlanGasMonitor`()
BEGIN
	DECLARE _hournow int;
    Set _hournow = hour(now());
    IF(_hournow > 5) then
SELECT dataplan.Model, COALESCE(c.QuantityActual, 0) AS QuantityActual, dataplan.QuantityDay,dataplan.Quantity1,dataplan.Quantity2,dataplan.Quantity3,dataplan.QuantityPerSec,dataplan.TimeStart,dataplan.TimeEnd,dataplan.TotalTime
FROM dataplan
LEFT JOIN (
    SELECT Model, COUNT(DISTINCT CodeBack) AS QuantityActual
    FROM dataplan
    LEFT JOIN (
        SELECT * FROM gas
        WHERE Judge = 'OK' AND DATE(TimePLC) = CURDATE() AND HOUR(TimePLC) > 5
    ) AS b ON dataplan.Model = b.CodeModel
    WHERE dataplan.Model <> 'ToTal' AND DATE(dataplan.TimeUpdate) = DATE(NOW())
    GROUP BY dataplan.Model
) AS c ON dataplan.Model = c.Model where dataplan.Model <> 'ToTal' And MonitorSpecial =1 AND DATE(dataplan.TimeUpdate) = DATE(NOW());
    else 
    SELECT dataplan.Model, COALESCE(c.QuantityActual, 0) AS QuantityActual, dataplan.QuantityDay,dataplan.Quantity1,dataplan.Quantity2,dataplan.Quantity3,dataplan.QuantityPerSec,dataplan.TimeStart,dataplan.TimeEnd,dataplan.TotalTime
FROM dataplan
LEFT JOIN (
    SELECT Model, COUNT(DISTINCT CodeBack) AS QuantityActual
    FROM dataplan
    LEFT JOIN (
        SELECT * FROM gas
        WHERE Judge = 'OK' AND ((Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5))
    ) AS b ON dataplan.Model = b.CodeModel
    WHERE dataplan.Model <> 'ToTal'   AND Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    GROUP BY dataplan.Model
) AS c ON dataplan.Model = c.Model where dataplan.Model <> 'ToTal' And MonitorSpecial =1 AND Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY);
   
	END IF;
END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadDataForLineChartPlanGas`(IN _ModelName nvarchar(30))
BEGIN
DECLARE _hournow int;
    Set _hournow = hour(now());
	if (_ModelName = 'all') then
    IF(_hournow > 5) then
   SELECT NameHour,COALESCE(b.Quantity, 0) AS Quantity FROM dataplc.datamastertime 
   LEFT JOIN (select hour(TimePLC) as GroupHour, count(DISTINCT CodeBack) as Quantity from gas 
   where Judge = 'OK' and Date(TimePLC) = curdate() and  hour(TimePLC)>5
   group by hour(TimePLC)) as b On datamastertime.NameHour = b.GroupHour;
 select  TimeStart, TimeEnd,QuantityDay,QuantityPerSec,TotalTime from dataplan where Model = 'Total' and Date(dataplan.TimeUpdate ) = Date(now()) limit 1;
    else
	SELECT NameHour,COALESCE(b.Quantity, 0) AS Quantity FROM dataplc.datamastertime 
	LEFT JOIN (select hour(TimePLC) as GroupHour, count(DISTINCT CodeBack) as Quantity from gas 
	where Judge = 'OK' and (Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND (hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5))
	group by hour(TimePLC)) as b On datamastertime.NameHour = b.GroupHour;
    
    select  TimeStart, TimeEnd,QuantityDay,QuantityPerSec,TotalTime from dataplan where Model = 'Total' and  Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) limit 1;
    END IF;
    else
     IF(_hournow > 5) then
   SELECT NameHour,COALESCE(b.Quantity, 0) AS Quantity FROM dataplc.datamastertime 
   LEFT JOIN (select hour(TimePLC) as GroupHour, count(DISTINCT CodeBack) as Quantity from gas 
   where Judge = 'OK' and CodeModel = _ModelName and Date(TimePLC) = curdate() and  hour(TimePLC)>5
   group by hour(TimePLC)) as b On datamastertime.NameHour = b.GroupHour;
 select  TimeStart, TimeEnd,QuantityDay,QuantityPerSec,TotalTime from dataplan where Model = _ModelName and Date(dataplan.TimeUpdate ) = Date(now()) limit 1;
    else
	SELECT NameHour,COALESCE(b.Quantity, 0) AS Quantity FROM dataplc.datamastertime 
	LEFT JOIN (select hour(TimePLC) as GroupHour, count(DISTINCT CodeBack) as Quantity from gas 
	where Judge = 'OK' and  CodeModel = _ModelName and ((Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5))
	group by hour(TimePLC)) as b On datamastertime.NameHour = b.GroupHour;
    
    select  TimeStart, TimeEnd,QuantityDay,QuantityPerSec,TotalTime from dataplan where Model = _ModelName and  Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) limit 1;
    END IF;
    END IF;
END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadDataForPieChartPlan`()
BEGIN
DECLARE rsOK int;
	DECLARE rsNG int;
    declare rsTotal int;
DECLARE _hournow int;
    Set _hournow = hour(now());
    IF(_hournow > 5) then
		select count(DISTINCT CodeBack) into rsTotal from gas where  Date(TimePLC) = curdate() and  hour(TimePLC)>5;
		select count(DISTINCT CodeBack) into rsOK from gas where Judge = 'OK' and Date(TimePLC) = curdate() and  hour(TimePLC)>5;
    set rsNG = rsTotal - rsOK;
    select rsOK as DataOK, rsNG as DataNG;
    else
		select count(DISTINCT CodeBack) into rsTotal from gas where (Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5);
		select count(DISTINCT CodeBack) into rsOK from gas where Judge = 'OK' and (Date(TimePLC) = curdate() and hour(TimePLC)>= 0 AND hour(TimePLC) < 6) or (DATE_SUB(CURDATE(), INTERVAL 1 DAY) = Date(TimePLC) AND hour(TimePLC)>5);
		set rsNG = rsTotal - rsOK;
		select rsOK as DataOK, rsNG as DataNG;
    END IF;
END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadDataPlan`()
BEGIN
	SELECT * FROM dataplc.dataplan where Date(TimeUpdate) = Date(now());
END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadModelPlan`()
BEGIN
	DECLARE _hournow int;
    Set _hournow = hour(now());
    IF(_hournow > 5) then
   SELECT Model FROM dataplan
   where Model <> 'Total' and  Date(dataplan.TimeUpdate ) = Date(now());
    else
    SELECT Model FROM dataplan
   where Model <> 'Total' and  Date(dataplan.TimeUpdate ) = DATE_SUB(CURDATE(), INTERVAL 1 DAY);
    END IF;
END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `LoadQuantityPlan`(IN _ModelName nvarchar(30))
BEGIN

if (_ModelName = 'all') then
select QuantityDay from dataplan where Model = 'Total';
else
select QuantityDay from dataplan where Model = _ModelName;
end if;

END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `MonitorSpecial`(IN _ModelName nvarchar(30))
BEGIN
if(exists(select MonitorSpecial from dataplan where Model = _ModelName and MonitorSpecial = 0))  then

UPDATE `dataplc`.`dataplan`
SET
`MonitorSpecial` = 1
WHERE Model = _ModelName;

else
	UPDATE `dataplc`.`dataplan`
SET
`MonitorSpecial` = 0
WHERE Model = _ModelName;
end if;

END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `MonitorSpecial`(IN _ModelName nvarchar(30))
BEGIN
if(exists(select MonitorSpecial from dataplan where Model = _ModelName and MonitorSpecial = 0))  then

UPDATE `dataplc`.`dataplan`
SET
`MonitorSpecial` = 1
WHERE Model = _ModelName;

else
	UPDATE `dataplc`.`dataplan`
SET
`MonitorSpecial` = 0
WHERE Model = _ModelName;
end if;

END

CREATE DEFINER=`TA`@`localhost` PROCEDURE `UpdateDateTimePlan`(IN _ModelName nvarchar(30),IN _TimeFrom datetime,IN _TimeTo datetime,IN _TotalTime double)
BEGIN
	UPDATE `dataplc`.`dataplan`
SET


`TotalTime` = _TotalTime,
`TimeStart` = _TimeFrom,
`TimeEnd` = _TimeTo

WHERE Model = _ModelName;

END